<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE SILENT EDGE | Elite Business Ledger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@200;400;600&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <style>
        :root { --navy: #0f172a; --steel: #334155; --silver: #cbd5e1; --zen-green: #10b981; --zen-red: #f43f5e; }
        body { background: radial-gradient(circle at top right, #1e293b, #020617); color: #f8fafc; font-family: 'Outfit', sans-serif; min-height: 100vh; margin: 0; }
        .glass { background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 24px; }
        .metric-card { background: linear-gradient(145deg, rgba(30, 41, 59, 0.4), rgba(15, 23, 42, 0.6)); border-radius: 20px; padding: 1.2rem; border: 1px solid rgba(255, 255, 255, 0.05); }
        .fc-theme-standard td, .fc-theme-standard th { border: 1px solid rgba(255,255,255,0.03) !important; }
        .fc-daygrid-day-number { font-size: 0.7rem; color: #64748b !important; padding: 8px !important; text-decoration: none !important; }
        .pnl-pos { color: var(--zen-green) !important; font-family: 'JetBrains Mono'; font-weight: 600; font-size: 0.75rem; text-align: center; }
        .pnl-neg { color: var(--zen-red) !important; font-family: 'JetBrains Mono'; font-weight: 600; font-size: 0.75rem; text-align: center; }
        .weekly-sum { font-size: 0.65rem; color: #94a3b8; border-left: 1px solid #334155; padding-left: 5px; margin-top: 5px; font-weight: bold; }
        .modal-container { position: fixed; inset: 0; z-index: 100; display: flex; justify-content: center; align-items: flex-start; padding: 2rem; overflow-y: auto; background: rgba(2, 6, 23, 0.98); }
        .modal-content { width: 100%; max-width: 1100px; margin-top: auto; margin-bottom: auto; }
        input, select, textarea { background: #0f172a !important; color: white !important; border: 1px solid #334155 !important; border-radius: 10px; padding: 10px; width: 100%; font-size: 0.85rem; }
        .btn-zen { background: #f8fafc; color: #0f172a; font-weight: 600; transition: all 0.3s ease; cursor: pointer; border: none; border-radius: 99px; }
        .btn-zen:hover { opacity: 0.8; transform: translateY(-1px); }
        .status-badge { font-size: 8px; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; font-weight: bold; cursor: pointer; }
        .hidden { display: none !important; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-[1700px] mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-center mb-10 gap-6">
            <div class="flex items-center gap-5">
                <div class="w-14 h-14 glass flex items-center justify-center border-slate-700 shadow-2xl tracking-tighter italic font-extralight text-xl">SE</div>
                <div>
                    <h1 class="text-3xl font-extralight tracking-[0.5em] text-white uppercase italic">The Silent Edge <span class="font-bold text-slate-400 not-italic">Trading</span></h1>
                    <p class="text-slate-500 text-[9px] uppercase tracking-[0.3em] font-bold">Zen Business Protocol • USD-MXN @ 18.15</p>
                </div>
            </div>
            <div class="flex gap-4">
                <button onclick="sincronizarGoogle()" class="px-6 py-2 rounded-full border border-slate-700 text-[10px] uppercase font-bold text-slate-400 hover:bg-slate-800 transition">Sync to Cloud ☁️</button>
                <button onclick="exportarDatos()" class="px-6 py-2 rounded-full border border-slate-700 text-[10px] uppercase font-bold text-slate-400">Export Backup</button>
                <button onclick="abrirModalRegistro()" class="btn-zen px-10 py-3 text-[10px] uppercase tracking-widest shadow-xl">Log Session</button>
            </div>
        </header>

        <div class="grid grid-cols-2 md:grid-cols-5 gap-6 mb-10 text-center text-white">
            <div class="metric-card"><p class="text-slate-500 text-[9px] uppercase font-bold tracking-widest mb-1">Disciplina (7d)</p><h2 id="kpiDisc" class="text-xl font-light">0.0 ⭐</h2></div>
            <div class="metric-card border-emerald-500/10"><p class="text-emerald-500/60 text-[9px] uppercase font-bold tracking-widest mb-1">Retiros Reales</p><h2 id="kpiRetiros" class="text-xl font-mono text-emerald-400">$0 MXN</h2></div>
            <div class="metric-card border-rose-500/10"><p class="text-rose-500/60 text-[9px] uppercase font-bold tracking-widest mb-1">Inversión Total</p><h2 id="kpiInv" class="text-xl font-mono text-rose-400">$0 MXN</h2></div>
            <div class="metric-card"><p class="text-slate-500 text-[9px] uppercase font-bold tracking-widest mb-1">Win Rate</p><h2 id="kpiWR" class="text-xl font-mono">0%</h2></div>
            <div class="metric-card"><p class="text-slate-500 text-[9px] uppercase font-bold tracking-widest mb-1">P&L Bruto</p><h2 id="kpiBruto" class="text-xl font-mono">$0.00</h2></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-10">
            <div class="lg:col-span-3 glass p-6 shadow-2xl relative">
                <div class="flex justify-between items-center mb-6 px-4 border-b border-slate-800 pb-4">
                    <h3 class="text-slate-400 text-[10px] uppercase font-bold tracking-widest">Global Session Ledger</h3>
                    <div id="pnlMensualHeader" class="text-sm font-mono text-white font-bold tracking-tighter italic">MONTHLY: $0.00 USD</div>
                </div>
                <div id="calendar"></div>
            </div>
            
            <div class="space-y-6">
                <div class="metric-card border-slate-700 bg-slate-900/40">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-slate-400 text-[10px] uppercase font-bold tracking-widest">Account Analytics</h3>
                        <button onclick="abrirModalFondeo()" class="text-xs text-white bg-slate-700 px-3 py-1 rounded-full font-bold hover:bg-white hover:text-black transition">+</button>
                    </div>
                    <div class="grid grid-cols-3 gap-2 mb-6 text-center border-b border-slate-800 pb-4">
                        <div><p class="text-[7px] text-slate-500 uppercase italic">Aprobación</p><p id="bizAppRate" class="text-xs font-bold text-white">0%</p></div>
                        <div><p class="text-[7px] text-slate-500 uppercase italic">Cobro (Pay)</p><p id="bizPayoutRate" class="text-xs font-bold text-white">0%</p></div>
                        <div><p class="text-[7px] text-slate-500 uppercase italic">ROI Real</p><p id="bizROI" class="text-xs font-bold text-emerald-400">0%</p></div>
                    </div>
                    <div id="analyticsCuentas" class="space-y-3"></div>
                    
                    <div id="strategyAnalysis" class="mt-8 border-t border-slate-800 pt-6">
                        <h3 class="text-slate-400 text-[10px] uppercase font-bold tracking-widest mb-4">Edge by Setup</h3>
                        <div id="strategyList" class="space-y-2"></div>
                    </div>
                </div>
                <div class="metric-card">
                    <p class="text-[9px] text-slate-500 uppercase font-bold mb-4 tracking-widest text-center italic">Equity Growth</p>
                    <canvas id="equityChart"></canvas>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-10 mt-10">
            <div class="glass p-8"><canvas id="monthlyChart"></canvas></div>
            <div class="glass p-8"><canvas id="ddChart"></canvas></div>
        </div>
    </div>

    <div id="modalTrade" class="hidden modal-container">
        <div class="glass modal-content p-10 my-10 shadow-2xl border-slate-700">
            <h2 id="modalTitle" class="text-xl font-extralight tracking-[0.3em] uppercase mb-10 text-white">Silent Execution</h2>
            <input type="hidden" id="editId">
            <div class="grid md:grid-cols-2 gap-12">
                <div class="space-y-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-[9px] uppercase text-slate-500 font-bold mb-1">Account</label><select id="tCuentaSelect"></select></div>
                        <div><label class="text-[9px] uppercase text-slate-500 font-bold mb-1">Setup</label>
                            <select id="tSetup">
                                <option value="J1">J1</option>
                                <option value="J2">J2</option>
                                <option value="J3 giro">J3 giro</option>
                                <option value="J3 rompimiento">J3 rompimiento</option>
                                <option value="J12">J12</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-[9px] uppercase text-slate-500">Date</label><input type="date" id="tFecha"></div>
                        <div><label class="text-[9px] uppercase text-slate-500">P&L USD</label><input type="number" id="tGanancia" step="0.01"></div>
                    </div>
                    <input type="number" id="tComision" step="0.01" placeholder="Comissions USD">
                    <div class="bg-slate-900/50 p-6 rounded-2xl border border-slate-800 space-y-3">
                        <p class="text-[9px] uppercase text-slate-500 font-bold italic">Zen Compliance Checklist</p>
                        <label class="flex items-center gap-4 text-xs"><input type="checkbox" class="tCheck w-5 h-5" value="C"> Contexto Válido</label>
                        <label class="flex items-center gap-4 text-xs"><input type="checkbox" class="tCheck w-5 h-5" value="G"> Confluencia GM</label>
                        <label class="flex items-center gap-4 text-xs"><input type="checkbox" class="tCheck w-5 h-5" value="T"> Timing Correcto</label>
                        <label class="flex items-center gap-4 text-xs"><input type="checkbox" class="tCheck w-5 h-5" value="I"> Entrada Técnica</label>
                        <label class="flex items-center gap-4 text-xs"><input type="checkbox" class="tCheck w-5 h-5" value="O"> Salida Técnica</label>
                    </div>
                </div>
                <div class="space-y-4">
                    <div class="w-full h-64 border-2 border-dashed border-slate-700 rounded-3xl flex items-center justify-center bg-slate-900/30 relative overflow-hidden cursor-pointer" id="dropZone">
                        <img id="preview" class="hidden absolute inset-0 w-full h-full object-contain">
                        <p class="text-slate-500 text-xs font-bold uppercase tracking-widest">Paste Image</p>
                        <input type="file" id="tImagen" class="hidden">
                    </div>
                    <textarea id="tNotas" rows="4" placeholder="Psychological journaling..."></textarea>
                </div>
            </div>
            <div class="flex gap-4 mt-10">
                <button onclick="guardarTrade()" class="btn-zen flex-1 py-4 uppercase text-[10px] tracking-widest">Commit Data</button>
                <button onclick="cerrarModal('modalTrade')" class="px-10 border border-slate-700 text-slate-500 rounded-full uppercase text-[10px]">Discard</button>
            </div>
        </div>
    </div>

    <div id="modalFondeo" class="hidden modal-container">
        <div class="metric-card w-full max-w-md bg-slate-900 border-slate-700 p-8 shadow-2xl my-auto">
            <h2 id="assetModalTitle" class="text-sm font-bold uppercase tracking-widest mb-6 text-slate-400">Asset Management</h2>
            <input type="hidden" id="editAssetId">
            <div class="space-y-4">
                <input type="text" id="fEmpresa" placeholder="Company Name">
                <div class="grid grid-cols-2 gap-4"><input type="number" id="fCosto" placeholder="Cost MXN"><input type="number" id="fDrawdown" placeholder="Max DD USD"></div>
                <input type="number" id="fStop" placeholder="Avg SL USD">
                <select id="fStatus"><option value="evaluacion">Evaluación</option><option value="aprobada">Aprobada</option><option value="quemada">Quemada</option><option value="retiro">Con Retiro</option></select>
                <input type="number" id="fRetiro" placeholder="Total Payout MXN">
                <div class="flex gap-3 pt-4"><button onclick="guardarFondeo()" class="flex-1 btn-zen py-3 uppercase text-[10px]">Save</button><button onclick="eliminarFondeo()" id="btnEliminarAsset" class="flex-1 border border-rose-900 text-rose-500 rounded-full py-3 uppercase text-[10px] hidden">Delete</button><button onclick="cerrarModal('modalFondeo')" class="flex-1 border border-slate-700 rounded-full py-3 text-slate-500 uppercase text-[10px]">Cancel</button></div>
            </div>
        </div>
    </div>

    <div id="modalReview" class="hidden modal-container">
        <div class="glass modal-content p-10 my-10 shadow-2xl border-slate-700">
            <div id="revContenido" class="flex flex-col gap-20"></div>
            <button onclick="cerrarModal('modalReview')" class="mt-20 w-full py-5 bg-slate-800 rounded-3xl text-[10px] font-bold tracking-widest uppercase text-slate-400 hover:text-white transition">Return to Ledger</button>
        </div>
    </div>

    <script>
        const TC = 18.15;
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby_gKWIG2ovJDxXCP5s4oBnca8JThVCXCYdQfOufpSJgi_w_Ha8zEkg4vTc-jqxB3jf/exec'; // Pegar tu URL de Apps Script aquí

        let trades = JSON.parse(localStorage.getItem('se_f_tr_final')) || [];
        let assets = JSON.parse(localStorage.getItem('se_f_as_final')) || [];
        let img64 = "";

        // SYNC GOOGLE
        async function sincronizarGoogle() {
            if (!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL.includes('TU_URL')) return alert("Configura la URL de Google primero.");
            const btn = event.target; btn.innerText = "Sincronizando...";
            try {
                await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', cache: 'no-cache', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ trades, assets }) });
                alert("Sincronización Exitosa con Google Sheet");
            } catch (e) { alert("Error al sincronizar"); }
            finally { btn.innerText = "Sync to Cloud ☁️"; }
        }

        const dz = document.getElementById('dropZone');
        dz.onclick = () => document.getElementById('tImagen').click();
        document.getElementById('tImagen').onchange = (e) => rImg(e.target.files[0]);
        document.onpaste = (e) => { const i = (e.clipboardData || e.originalEvent.clipboardData).items[0]; if (i?.type.includes("image")) rImg(i.getAsFile()); };
        function rImg(f) { const r = new FileReader(); r.onload = (e) => { img64 = e.target.result; document.getElementById('preview').src = img64; document.getElementById('preview').classList.remove('hidden'); }; r.readAsDataURL(f); }

        function abrirModal(id) { const m = document.getElementById(id); m.classList.remove('hidden'); m.scrollTo(0,0); }
        function cerrarModal(id) { document.getElementById(id).classList.add('hidden'); }

        function abrirModalFondeo(id = null) {
            const btnEl = document.getElementById('btnEliminarAsset');
            if(id) {
                const a = assets.find(x => x.id == id);
                document.getElementById('editAssetId').value = id;
                document.getElementById('fEmpresa').value = a.empresa;
                document.getElementById('fCosto').value = a.costo;
                document.getElementById('fDrawdown').value = a.drawdown;
                document.getElementById('fStop').value = a.stop;
                document.getElementById('fStatus').value = a.status;
                document.getElementById('fRetiro').value = a.retiro;
                btnEl.classList.remove('hidden');
            } else {
                document.getElementById('editAssetId').value = ""; document.getElementById('fEmpresa').value = ""; 
                document.getElementById('fCosto').value = ""; document.getElementById('fDrawdown').value = "";
                document.getElementById('fStop').value = ""; document.getElementById('fStatus').value = "evaluacion";
                document.getElementById('fRetiro').value = 0; btnEl.classList.add('hidden');
            }
            abrirModal('modalFondeo');
        }

        function guardarFondeo() {
            const aid = document.getElementById('editAssetId').value;
            const emp = document.getElementById('fEmpresa').value;
            const seq = aid ? assets.find(x => x.id == aid).sec : assets.filter(a => a.empresa.toLowerCase() === emp.toLowerCase()).length + 1;
            const data = { id: aid || Date.now().toString(), empresa: emp, sec: seq, costo: parseFloat(document.getElementById('fCosto').value)||0, drawdown: parseFloat(document.getElementById('fDrawdown').value)||1, stop: parseFloat(document.getElementById('fStop').value)||1, status: document.getElementById('fStatus').value, retiro: parseFloat(document.getElementById('fRetiro').value)||0 };
            if(aid) assets = assets.map(x => x.id == aid ? data : x); else assets.push(data);
            actualizar(); cerrarModal('modalFondeo');
        }

        function eliminarFondeo() {
            if(confirm("Delete asset and linked trades?")) {
                const aid = document.getElementById('editAssetId').value;
                trades = trades.filter(t => t.cid != aid);
                assets = assets.filter(a => a.id != aid);
                actualizar(); cerrarModal('modalFondeo');
            }
        }

        function abrirModalRegistro(id = null) {
            if(!assets.length) return alert("Add an account first");
            document.getElementById('editId').value = id || "";
            document.getElementById('tCuentaSelect').innerHTML = assets.map(a => `<option value="${a.id}">${a.empresa} #${a.sec}</option>`).join('');
            if(id) {
                const t = trades.find(x => x.id == id);
                document.getElementById('tFecha').value = t.fecha; document.getElementById('tGanancia').value = t.gb;
                document.getElementById('tComision').value = t.com; document.getElementById('tNotas').value = t.notas;
                document.getElementById('tCuentaSelect').value = t.cid; document.getElementById('tSetup').value = t.st || 'J1';
                img64 = t.img; if(t.img) { document.getElementById('preview').src = t.img; document.getElementById('preview').classList.remove('hidden'); }
            } else {
                document.getElementById('tGanancia').value = ""; document.getElementById('tComision').value = "";
                document.getElementById('tNotas').value = ""; document.getElementById('preview').classList.add('hidden');
                img64 = ""; document.querySelectorAll('.tCheck').forEach(c => c.checked = false);
            }
            abrirModal('modalTrade');
        }

        function guardarTrade() {
            const eid = document.getElementById('editId').value;
            const sc = Array.from(document.querySelectorAll('.tCheck:checked')).length;
            const gb = parseFloat(document.getElementById('tGanancia').value)||0;
            const cm = parseFloat(document.getElementById('tComision').value)||0;
            const t = { id: eid ? parseInt(eid) : Date.now(), cid: document.getElementById('tCuentaSelect').value, st: document.getElementById('tSetup').value, fecha: document.getElementById('tFecha').value, gb, com: cm, gn: gb - cm, sc, notas: document.getElementById('tNotas').value, img: img64 };
            if(!t.fecha) return alert("Select a date");
            if(eid) trades = trades.map(x => x.id == eid ? t : x); else trades.push(t);
            actualizar(); cerrarModal('modalTrade');
        }

        function actualizar() {
            localStorage.setItem('se_f_tr_final', JSON.stringify(trades));
            localStorage.setItem('se_f_as_final', JSON.stringify(assets));
            renderStats(); renderCalendar(); renderCharts(); renderBusiness(); renderStrategies();
        }

        function renderStats() {
            const br = trades.reduce((a,b)=>a+b.gb, 0);
            const inv = assets.reduce((a,b)=>a+b.costo, 0);
            const ret = assets.reduce((a,b)=>a+b.retiro, 0);
            const wr = trades.length ? (trades.filter(t=>t.gn>0).length/trades.length*100).toFixed(0) : 0;
            const s7 = new Date(); s7.setDate(s7.getDate()-7);
            const t7 = trades.filter(t => new Date(t.fecha) >= s7);
            const avg = t7.length ? (t7.reduce((a,b)=>a+b.sc,0)/t7.length).toFixed(1) : "0.0";
            document.getElementById('kpiBruto').innerText = `$${br.toLocaleString()}`;
            document.getElementById('kpiRetiros').innerText = `$${ret.toLocaleString()} MXN`;
            document.getElementById('kpiInv').innerText = `$${inv.toLocaleString()} MXN`;
            document.getElementById('kpiWR').innerText = `${wr}%`;
            document.getElementById('kpiDisc').innerText = `${avg} ⭐`;
        }

        function renderCalendar() {
            const daily = trades.reduce((acc, t) => { acc[t.fecha] = (acc[t.fecha] || 0) + t.gn; return acc; }, {});
            const evs = Object.keys(daily).map(d => ({ title: `$${daily[d].toFixed(0)}`, start: d, className: daily[d] >= 0 ? 'pnl-pos' : 'pnl-neg' }));
            const cal = new FullCalendar.Calendar(document.getElementById('calendar'), {
                initialView: 'dayGridMonth', locale: 'es', events: evs, height: 'auto',
                eventClick: (info) => review(info.event.startStr),
                datesSet: (info) => {
                    const mKey = info.view.currentStart.toISOString().substring(0,7);
                    const mTotal = trades.filter(t => t.fecha.startsWith(mKey)).reduce((a,b)=>a+b.gn, 0);
                    document.getElementById('pnlMensualHeader').innerText = `MONTHLY: $${mTotal.toFixed(2)} USD`;
                    setTimeout(weeklySums, 150);
                }
            });
            cal.render();
        }

        function weeklySums() {
            document.querySelectorAll('.weekly-sum').forEach(e => e.remove());
            document.querySelectorAll('.fc-daygrid-body tr').forEach(row => {
                let sum = 0; row.querySelectorAll('.fc-event-title').forEach(el => sum += parseFloat(el.innerText.replace('$','')));
                const cell = row.querySelector('.fc-daygrid-day:last-child');
                if(cell) { const d = document.createElement('div'); d.className = 'weekly-sum'; d.innerText = `W: $${sum.toFixed(0)}`; d.style.color = sum>=0?'#34d399':'#f43f5e'; cell.appendChild(d); }
            });
        }

        function renderCharts() {
            const sorted = [...trades].sort((a,b)=>new Date(a.fecha)-new Date(b.fecha));
            const ctxE = document.getElementById('equityChart').getContext('2d');
            if(window.chE) window.chE.destroy();
            let c = 0; const dataE = sorted.map(t=>c+=t.gn);
            window.chE = new Chart(ctxE, { type:'line', data:{ labels:sorted.map(t=>t.fecha), datasets:[{data:dataE, borderColor:'#fff', backgroundColor:'rgba(255,255,255,0.05)', fill:true, tension:0.3, pointRadius:1}]}, options:{plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{grid:{color:'rgba(255,255,255,0.05)'},ticks:{color:'#64748b', font:{size:8}}}}} });
            const ctxM = document.getElementById('monthlyChart').getContext('2d');
            if(window.chM) window.chM.destroy();
            const ms = {}; trades.forEach(t => { const m = t.fecha.substring(0,7); ms[m] = (ms[m]||0)+t.gn; });
            window.chM = new Chart(ctxM, { type:'bar', data:{ labels:Object.keys(ms), datasets:[{data:Object.values(ms), backgroundColor:Object.values(ms).map(v=>v>=0?'#10b981':'#f43f5e')}]}, options:{plugins:{legend:{display:false}}, scales:{y:{grid:{color:'rgba(255,255,255,0.05)'},ticks:{color:'#64748b'}}, x:{ticks:{color:'#64748b', font:{size:9}}}}} });
            const ctxD = document.getElementById('ddChart').getContext('2d');
            if(window.chD) window.chD.destroy();
            let peak = 0; const dataD = dataE.map(v => { if(v > peak) peak = v; return v - peak; });
            window.chD = new Chart(ctxD, { type:'line', data:{ labels:sorted.map(t=>t.fecha), datasets:[{data:dataD, borderColor:'#f43f5e', backgroundColor:'rgba(244,63,94,0.1)', fill:true, pointRadius:0}]}, options:{plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{ticks:{color:'#64748b'}}}} });
        }

        function renderBusiness() {
            const cont = document.getElementById('analyticsCuentas'); cont.innerHTML = "";
            if(!assets.length) return cont.innerHTML = "<p class='text-[9px] text-slate-600 text-center italic'>No accounts.</p>";
            const inv = assets.reduce((a,b)=>a+b.costo, 0);
            const ret = assets.reduce((a,b)=>a+b.retiro, 0);
            document.getElementById('bizAppRate').innerText = `${((assets.filter(a => a.status !== 'evaluacion' && a.status !== 'quemada').length / assets.length) * 100).toFixed(0)}%`;
            document.getElementById('bizPayoutRate').innerText = `${((assets.filter(a => a.status === 'retiro').length / assets.length) * 100).toFixed(0)}%`;
            document.getElementById('bizROI').innerText = `${inv>0?(((ret-inv)/inv)*100).toFixed(0):0}%`;
            const comps = [...new Set(assets.map(a => a.empresa))];
            comps.forEach(e => {
                const list = assets.filter(a => a.empresa === e);
                const pnl = trades.filter(t => list.find(l => l.id == t.cid)).reduce((a,b)=>a+b.gn, 0);
                let div = `<div class="bg-slate-950/40 p-3 rounded-xl border border-slate-800 mb-2"><div class="flex justify-between font-bold mb-1 uppercase text-[11px] text-white"><span>${e}</span><span class="${pnl>=0?'text-emerald-500':'text-rose-500'}">$${pnl.toFixed(0)}</span></div><div class="flex flex-wrap gap-1 mt-2">`;
                list.forEach(acc => {
                    const c = acc.status === 'retiro'?'bg-emerald-500':acc.status === 'aprobada'?'bg-blue-500':acc.status === 'quemada'?'bg-rose-500':'bg-slate-700';
                    div += `<span onclick="abrirModalFondeo('${acc.id}')" class="status-badge ${c} text-white">#${acc.sec}</span>`;
                });
                cont.innerHTML += div + `</div></div>`;
            });
        }

        function renderStrategies() {
            const list = document.getElementById('strategyList'); list.innerHTML = "";
            const stats = {};
            trades.forEach(t => {
                const s = t.st || 'J1';
                if(!stats[s]) stats[s] = { p: 0, w: 0, t: 0 };
                stats[s].p += t.gn; stats[s].t += 1; if(t.gn > 0) stats[s].w += 1;
            });
            for(let s in stats) {
                const st = stats[s]; const wr = ((st.w/st.t)*100).toFixed(0);
                list.innerHTML += `<div class="flex justify-between items-center text-[10px] bg-slate-900/50 p-2 rounded-lg border border-slate-800"><span class="text-slate-400 font-bold">${s}</span><span class="${st.p>=0?'text-emerald-400':'text-rose-400'} font-mono">$${st.p.toFixed(0)}</span><span class="text-slate-600">${wr}% WR</span></div>`;
            }
        }

        function review(f) {
            const trs = trades.filter(t => t.fecha === f);
            const cont = document.getElementById('revContenido');
            cont.innerHTML = trs.map(t => {
                const a = assets.find(x => x.id == t.cid);
                const mxn = t.gn < 0 && a ? ((Math.abs(t.gn)/a.drawdown)*a.costo).toFixed(0) : (t.gn * TC).toFixed(0);
                return `<div class="grid lg:grid-cols-3 gap-10 border-b border-slate-800 pb-20 items-start">
                    <div class="space-y-6">
                        <div class="flex justify-between items-center"><span class="text-slate-500 uppercase font-bold text-xs">${a?a.empresa+' #'+a.sec:''} - ${t.st}</span><button onclick="abrirModalRegistro(${t.id})" class="bg-slate-700 text-white px-4 py-1 rounded-full text-[10px]">Edit</button></div>
                        <div class="text-6xl font-extralight ${t.gn>=0?'text-emerald-400':'text-rose-500'} font-mono tracking-tighter">$${t.gn.toFixed(2)}</div>
                        <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">${t.gn<0?'Impact:':'Value:'} <span class="text-white">$${mxn} MXN</span></p>
                        <div class="text-2xl">${"⭐".repeat(t.sc)}</div>
                        <div class="text-slate-400 italic text-sm border-l-2 border-slate-700 pl-4 py-2">"${t.notas || 'No journaling notes.'}"</div>
                        <button onclick="borrar(${t.id})" class="text-[9px] text-rose-900 uppercase font-bold hover:text-rose-500 transition">Delete Permanently</button>
                    </div>
                    <div class="lg:col-span-2"><img src="${t.img}" class="w-full rounded-[2rem] border border-slate-800 shadow-2xl"></div>
                </div>`;
            }).join('');
            abrirModal('modalReview');
        }

        function borrar(id) { if(confirm("Delete?")) { trades = trades.filter(x=>x.id!=id); actualizar(); cerrarModal('modalReview'); } }
        function exportarDatos() { const b = new Blob([JSON.stringify({trades, assets})], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `SE_Master_2026.json`; a.click(); }
        actualizar();
    </script>
</body>
</html>
