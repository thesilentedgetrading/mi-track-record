<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NQ Ultra Dashboard - NinjaTrader Journal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <style>
        body { background-color: #0b0f1a; color: #e2e8f0; font-family: 'Inter', sans-serif; }
        .card { background-color: #161d2f; border: 1px solid #2d3748; border-radius: 12px; padding: 1.5rem; }
        .fc-daygrid-day-number { color: #94a3b8 !important; font-size: 0.8rem; text-decoration: none !important; }
        .pnl-pos { color: #10b981 !important; font-weight: bold; cursor: pointer; text-align: center; }
        .pnl-neg { color: #ef4444 !important; font-weight: bold; cursor: pointer; text-align: center; }
        input, select, textarea { background-color: #1f2937 !important; color: white !important; border: 1px solid #374151 !important; width: 100%; border-radius: 6px; padding: 10px; font-size: 0.9rem; }
        input:focus, textarea:focus { border-color: #3b82f6 !important; outline: none; }
        .fc-event { background: transparent !important; border: none !important; }
        .fc-theme-standard td, .fc-theme-standard th { border: 1px solid #2d3748 !important; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
    </style>
</head>
<body class="p-4 md:p-6">

    <div class="max-w-[1500px] mx-auto">
        <header class="flex flex-col lg:flex-row justify-between items-center mb-8 gap-6 border-b border-gray-800 pb-6">
            <div>
                <h1 class="text-3xl font-bold text-white tracking-tight">NQ Future <span class="text-blue-500">Track</span></h1>
                <p class="text-gray-400 text-sm">Registro Profesional de Futuros & Disciplina Operativa</p>
            </div>
            <div class="flex flex-wrap justify-center gap-3">
                <button onclick="exportarDatos()" class="bg-gray-800 hover:bg-gray-700 text-gray-200 px-4 py-2 rounded-lg text-sm font-semibold transition flex items-center gap-2">üíæ Exportar JSON</button>
                <label class="bg-gray-800 hover:bg-gray-700 text-gray-200 px-4 py-2 rounded-lg text-sm font-semibold cursor-pointer transition flex items-center gap-2">
                    üìÇ Importar Backups <input type="file" id="importar" class="hidden" onchange="importarDatos(event)">
                </label>
                <button onclick="abrirModal('modalTrade')" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg font-bold shadow-lg shadow-blue-900/20 transition">+ Nuevo Trade</button>
            </div>
        </header>

        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
            <div class="card border-l-4 border-l-blue-500"><p class="text-gray-500 text-[10px] uppercase font-bold mb-1">Net P&L Total</p><p id="netPL" class="text-2xl font-mono font-bold">$0</p></div>
            <div class="card border-l-4 border-l-purple-500"><p class="text-gray-500 text-[10px] uppercase font-bold mb-1">Win Rate</p><p id="winRate" class="text-2xl font-mono font-bold">0%</p></div>
            <div class="card border-l-4 border-l-yellow-500"><p class="text-gray-500 text-[10px] uppercase font-bold mb-1">Profit Factor</p><p id="profitFactor" class="text-2xl font-mono font-bold">0.00</p></div>
            <div class="card border-l-4 border-l-green-500"><p class="text-gray-500 text-[10px] uppercase font-bold mb-1">Avg Trade</p><p id="avgTrade" class="text-2xl font-mono font-bold">$0</p></div>
            <div class="card border-l-4 border-l-indigo-500"><p class="text-gray-500 text-[10px] uppercase font-bold mb-1">Total Puntos NQ</p><p id="totalPts" class="text-2xl font-mono font-bold">0.00</p></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 card shadow-xl">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-gray-300">Calendario de Sesiones</h3>
                    <span class="text-[10px] text-gray-500 italic">Haz clic en un d√≠a para ver el detalle</span>
                </div>
                <div id="calendar"></div>
            </div>

            <div class="space-y-6">
                <div class="card">
                    <h3 class="font-bold mb-4 text-gray-300">Equity Curve</h3>
                    <canvas id="equityChart"></canvas>
                </div>
                <div class="card bg-gradient-to-br from-[#161d2f] to-[#1e293b]">
                    <h3 class="font-bold mb-2 text-gray-300">Resumen de Cuentas</h3>
                    <div id="listaCuentas" class="space-y-3 text-sm mt-4">
                        </div>
                    <button onclick="abrirModal('modalFondeo')" class="w-full mt-6 py-2 border border-dashed border-gray-600 text-gray-400 rounded-lg hover:border-blue-500 hover:text-blue-400 transition text-xs font-bold">+ AGREGAR CUENTA DE FONDEO</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modalTrade" class="hidden fixed inset-0 bg-black/95 backdrop-blur-md flex justify-center items-center p-4 z-50">
        <div class="card w-full max-w-4xl max-h-[95vh] overflow-y-auto border-blue-500/30 shadow-2xl">
            <h2 class="text-2xl font-bold mb-6 text-blue-400 font-mono tracking-tighter uppercase">Bit√°cora de Sesi√≥n - NQ</h2>
            <div class="grid lg:grid-cols-2 gap-8">
                <div class="space-y-5">
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-[10px] text-gray-400 uppercase font-bold">Fecha de Operaci√≥n</label><input type="date" id="tFecha" class="mt-1"></div>
                        <div><label class="text-[10px] text-gray-400 uppercase font-bold">Puntos Netos</label><input type="number" step="0.25" id="tPuntos" placeholder="0.00" class="mt-1"></div>
                    </div>
                    <div><label class="text-[10px] text-gray-400 uppercase font-bold text-green-400">Resultado Final ($)</label><input type="number" id="tGanancia" placeholder="Ej: 500 o -200" class="mt-1 border-green-900"></div>
                    
                    <div>
                        <label class="text-[10px] text-blue-400 uppercase font-bold mb-2 block tracking-widest">Checklist de Estrategia</label>
                        <div class="grid grid-cols-2 gap-2 bg-gray-900/50 p-4 rounded-xl border border-gray-800">
                            <label class="flex items-center gap-2 text-xs cursor-pointer"><input type="checkbox" class="tCheck w-4 h-4" value="Contexto HTF"> Contexto HTF</label>
                            <label class="flex items-center gap-2 text-xs cursor-pointer"><input type="checkbox" class="tCheck w-4 h-4" value="Zona de Valor"> Zona de Valor</label>
                            <label class="flex items-center gap-2 text-xs cursor-pointer"><input type="checkbox" class="tCheck w-4 h-4" value="Gatillo/Entry"> Gatillo / Entry</label>
                            <label class="flex items-center gap-2 text-xs cursor-pointer"><input type="checkbox" class="tCheck w-4 h-4" value="Stop T√©cnico"> Stop T√©cnico</label>
                            <label class="flex items-center gap-2 text-xs cursor-pointer"><input type="checkbox" class="tCheck w-4 h-4" value="Riesgo 1:2+"> Riesgo 1:2+</label>
                            <label class="flex items-center gap-2 text-xs cursor-pointer"><input type="checkbox" class="tCheck w-4 h-4" value="Disciplina"> Disciplina 100%</label>
                        </div>
                    </div>
                    <div><label class="text-[10px] text-gray-400 uppercase font-bold">Notas y Psicolog√≠a</label><textarea id="tNotas" rows="3" placeholder="¬øC√≥mo te sentiste hoy?" class="mt-1"></textarea></div>
                </div>

                <div class="flex flex-col h-full">
                    <label class="text-[10px] text-gray-400 uppercase font-bold mb-1">Captura de NinjaTrader</label>
                    <div class="flex-grow border-2 border-dashed border-gray-700 rounded-xl flex flex-col items-center justify-center p-6 bg-gray-900/30 hover:border-blue-500 transition cursor-pointer relative overflow-hidden" id="dropZone">
                        <img id="preview" class="hidden absolute inset-0 w-full h-full object-contain z-10">
                        <div class="text-center z-0">
                            <p class="text-blue-500 font-bold mb-1">Pega tu gr√°fica aqu√≠</p>
                            <p class="text-[10px] text-gray-500 uppercase">Cmd+V o haz clic para subir</p>
                        </div>
                        <input type="file" id="tImagen" class="hidden" accept="image/*">
                    </div>
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                <button onclick="guardarTrade()" class="flex-1 bg-blue-600 hover:bg-blue-500 p-4 rounded-xl font-bold shadow-lg shadow-blue-900/40 transition">GUARDAR SESI√ìN</button>
                <button onclick="cerrarModal('modalTrade')" class="w-32 bg-gray-800 p-4 rounded-xl font-bold transition">CANCELAR</button>
            </div>
        </div>
    </div>

    <div id="modalReview" class="hidden fixed inset-0 bg-black/98 flex justify-center items-center p-4 z-50">
        <div class="card w-full max-w-6xl max-h-[90vh] overflow-y-auto border-gray-700 shadow-2xl">
            <div class="flex justify-between items-center mb-6 sticky top-0 bg-[#161d2f] z-20 pb-4">
                <div>
                    <h2 id="revFecha" class="text-3xl font-black text-white">Sesi√≥n NQ</h2>
                </div>
                <button onclick="cerrarModal('modalReview')" class="text-gray-500 hover:text-white text-4xl">&times;</button>
            </div>
            <div id="revContenido" class="grid lg:grid-cols-3 gap-8">
                </div>
        </div>
    </div>

    <div id="modalFondeo" class="hidden fixed inset-0 bg-black/90 flex justify-center items-center p-4 z-50">
        <div class="card w-full max-w-sm">
            <h2 class="text-xl font-bold mb-4">Nueva Prueba de Fondeo</h2>
            <div class="space-y-4">
                <input type="text" id="fEmpresa" placeholder="Ej: Topstep / Apex">
                <input type="text" id="fTamano" placeholder="Ej: 50k / 150k">
                <input type="number" id="fCosto" placeholder="Costo de la prueba ($)">
                <div class="flex gap-2 pt-2">
                    <button onclick="guardarFondeo()" class="flex-1 bg-green-600 p-2 rounded font-bold">A√±adir</button>
                    <button onclick="cerrarModal('modalFondeo')" class="flex-1 bg-gray-700 p-2 rounded">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let trades = JSON.parse(localStorage.getItem('nq_pro_final')) || [];
        let fondeo = JSON.parse(localStorage.getItem('nq_fondeo_final')) || [];
        let imagenBase64 = "";

        // MANEJO DE IM√ÅGENES
        const dz = document.getElementById('dropZone');
        dz.onclick = () => document.getElementById('tImagen').click();
        document.getElementById('tImagen').onchange = (e) => leerImagen(e.target.files[0]);
        document.onpaste = (e) => {
            const item = (e.clipboardData || e.originalEvent.clipboardData).items[0];
            if (item && item.type.indexOf("image") !== -1) leerImagen(item.getAsFile());
        };

        function leerImagen(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                imagenBase64 = e.target.result;
                const prev = document.getElementById('preview');
                prev.src = imagenBase64;
                prev.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        // MODALES
        function abrirModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function cerrarModal(id) { 
            document.getElementById(id).classList.add('hidden'); 
            if(id === 'modalTrade') {
                imagenBase64 = "";
                document.getElementById('preview').classList.add('hidden');
                document.querySelectorAll('.tCheck').forEach(c => c.checked = false);
                document.getElementById('tNotas').value = "";
                document.getElementById('tPuntos').value = "";
                document.getElementById('tGanancia').value = "";
            }
        }

        // GUARDAR DATOS
        function guardarTrade() {
            const checks = Array.from(document.querySelectorAll('.tCheck:checked')).map(c => c.value);
            const t = {
                id: Date.now(),
                fecha: document.getElementById('tFecha').value,
                puntos: parseFloat(document.getElementById('tPuntos').value) || 0,
                ganancia: parseFloat(document.getElementById('tGanancia').value) || 0,
                notas: document.getElementById('tNotas').value,
                checks: checks,
                imagen: imagenBase64
            };
            if(!t.fecha) return alert("Por favor selecciona una fecha");
            trades.push(t);
            actualizarTodo();
            cerrarModal('modalTrade');
        }

        function guardarFondeo() {
            fondeo.push({
                id: Date.now(),
                empresa: document.getElementById('fEmpresa').value,
                tamano: document.getElementById('fTamano').value,
                costo: parseFloat(document.getElementById('fCosto').value) || 0
            });
            actualizarTodo();
            cerrarModal('modalFondeo');
        }

        // RENDERIZADO
        function actualizarTodo() {
            localStorage.setItem('nq_pro_final', JSON.stringify(trades));
            localStorage.setItem('nq_fondeo_final', JSON.stringify(fondeo));
            renderStats();
            renderCalendar();
            renderFondeo();
        }

        function renderStats() {
            const net = trades.reduce((a, b) => a + b.ganancia, 0);
            const wins = trades.filter(t => t.ganancia > 0);
            const loss = trades.filter(t => t.ganancia < 0);
            const wr = trades.length ? (wins.length / trades.length * 100).toFixed(1) : 0;
            
            const grossProfit = wins.reduce((a,b) => a+b.ganancia,0);
            const grossLoss = Math.abs(loss.reduce((a,b) => a+b.ganancia,0));
            const pf = grossLoss > 0 ? (grossProfit / grossLoss).toFixed(2) : (grossProfit > 0 ? "MAX" : "0.00");

            document.getElementById('netPL').innerText = `$${net.toLocaleString()}`;
            document.getElementById('netPL').className = net >= 0 ? 'text-2xl font-mono font-bold text-green-400' : 'text-2xl font-mono font-bold text-red-400';
            document.getElementById('winRate').innerText = `${wr}%`;
            document.getElementById('profitFactor').innerText = pf;
            document.getElementById('avgTrade').innerText = `$${trades.length ? (net/trades.length).toFixed(0) : 0}`;
            document.getElementById('totalPts').innerText = trades.reduce((a,b)=>a+b.puntos,0).toFixed(2);

            // Gr√°fico de Equity
            const ctx = document.getElementById('equityChart').getContext('2d');
            if(window.eqChart) window.eqChart.destroy();
            let cum = 0;
            const data = trades.sort((a,b)=>new Date(a.fecha)-new Date(b.fecha)).map(t=> { cum += t.ganancia; return cum; });
            window.eqChart = new Chart(ctx, {
                type: 'line',
                data: { labels: data.map((_,i)=>i+1), datasets: [{ label: 'Capital', data: data, borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.1)', fill: true, tension: 0.3 }] },
                options: { plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { grid: { color: '#2d3748' } } } }
            });
        }

        function renderCalendar() {
            const daily = trades.reduce((acc, t) => {
                acc[t.fecha] = (acc[t.fecha] || 0) + t.ganancia;
                return acc;
            }, {});

            const events = Object.keys(daily).map(date => ({
                title: `$${daily[date].toLocaleString()}`,
                start: date,
                className: daily[date] >= 0 ? 'pnl-pos' : 'pnl-neg'
            }));

            const calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
                initialView: 'dayGridMonth',
                locale: 'es',
                firstDay: 1,
                events: events,
                height: 'auto',
                eventClick: (info) => mostrarReview(info.event.startStr),
                eventContent: (arg) => ({ html: `<div class="${arg.event.classNames[0]} p-1 text-xs rounded">${arg.event.title}</div>` })
            });
            calendar.render();
        }

        function mostrarReview(fechaStr) {
            const diaTrades = trades.filter(t => t.fecha === fechaStr);
            document.getElementById('revFecha').innerText = `Bit√°cora: ${fechaStr}`;
            const cont = document.getElementById('revContenido');
            cont.innerHTML = "";

            diaTrades.forEach(t => {
                const checksHtml = t.checks?.map(c => `<span class="bg-blue-900/30 text-blue-400 px-2 py-1 rounded text-[10px] border border-blue-800">‚úì ${c}</span>`).join(' ') || "";
                cont.innerHTML += `
                    <div class="lg:col-span-1 space-y-6 bg-gray-900/40 p-6 rounded-2xl border border-gray-800">
                        <div>
                            <p class="text-[10px] text-gray-500 uppercase font-bold tracking-widest">Resultado Sesi√≥n</p>
                            <div class="text-4xl font-black ${t.ganancia >= 0 ? 'text-green-400' : 'text-red-400'}">$${t.ganancia.toLocaleString()}</div>
                            <div class="text-blue-500 font-mono text-lg">${t.puntos} Puntos NQ</div>
                        </div>
                        <div>
                            <p class="text-[10px] text-gray-500 uppercase font-bold mb-2">Checklist de Estrategia</p>
                            <div class="flex flex-wrap gap-2">${checksHtml}</div>
                        </div>
                        <div>
                            <p class="text-[10px] text-gray-500 uppercase font-bold mb-2">Psicolog√≠a & Notas</p>
                            <div class="text-gray-300 italic text-sm leading-relaxed bg-[#0b0f1a] p-4 rounded-xl border-l-4 border-blue-600">"${t.notas || 'Sin comentarios registrados'}"</div>
                        </div>
                        <button onclick="borrarTrade(${t.id})" class="w-full py-2 text-xs text-red-900 hover:text-red-500 transition font-bold uppercase tracking-widest">Eliminar Registro</button>
                    </div>
                    <div class="lg:col-span-2 space-y-2">
                        <p class="text-[10px] text-gray-500 uppercase font-bold">Gr√°fica del Trade (NinjaTrader)</p>
                        ${t.imagen ? `<img src="${t.imagen}" class="w-full rounded-2xl border border-gray-800 shadow-2xl">` : `<div class="aspect-video bg-gray-900 flex items-center justify-center text-gray-700 italic rounded-2xl border border-gray-800">No se adjunt√≥ imagen</div>`}
                    </div>
                `;
            });
            abrirModal('modalReview');
        }

        function borrarTrade(id) {
            if(confirm("¬øSeguro que quieres borrar este trade? Esta acci√≥n no se puede deshacer.")) {
                trades = trades.filter(t => t.id !== id);
                actualizarTodo();
                cerrarModal('modalReview');
            }
        }

        function renderFondeo() {
            const div = document.getElementById('listaCuentas');
            div.innerHTML = "";
            let inversionTotal = 0;
            fondeo.forEach(f => {
                inversionTotal += f.costo;
                div.innerHTML += `
                    <div class="flex justify-between items-center group">
                        <span class="text-gray-300">${f.empresa} <span class="text-[10px] text-gray-500 font-mono">${f.tamano}</span></span>
                        <span class="text-red-400 font-mono text-xs">-$${f.costo}</span>
                    </div>
                `;
            });
            if(fondeo.length > 0) {
                div.innerHTML += `<div class="border-t border-gray-700 pt-2 flex justify-between font-bold text-xs"><span class="text-gray-500">INVERSI√ìN TOTAL</span><span class="text-red-500">$${inversionTotal}</span></div>`;
            } else {
                div.innerHTML = "<p class='text-gray-600 italic text-xs'>No hay cuentas registradas</p>";
            }
        }

        function exportarDatos() {
            const data = { trades, fondeo };
            const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `NQ_Journal_Backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        function importarDatos(e) {
            const reader = new FileReader();
            reader.onload = (f) => {
                const data = JSON.parse(f.target.result);
                trades = data.trades || [];
                fondeo = data.fondeo || [];
                actualizarTodo();
                alert("Backup cargado con √©xito");
            };
            reader.readAsText(e.target.files[0]);
        }

        actualizarTodo();
    </script>
</body>
</html>